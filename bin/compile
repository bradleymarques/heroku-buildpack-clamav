#!/usr/bin/env bash
# bin/compile build_path cache_path
#
# See https://blog.heroku.com/hacking-buildpacks#compile for good documentation
#
# build - gives you a handle for the root directory of the app
# cache - gives you a location to persist build artifacts between deployments
#
build="$1" # something like /tmp/build_<uuid>
cache="$2" # /app/tmp/cache

set -e
mkdir -p "${cache}/clamav-data"

mkdir -p "${build}/clamav" # this will be created in the root directory of the app.
touch "${build}/clamav/freshclam.conf"
echo "DatabaseMirror database.clamav.net" >> "${build}/clamav/freshclam.conf"

# Override the specified datadir so we retain changes via the cache.
freshclam --config-file="${build}/clamav/freshclam.conf" --datadir="${cache}/clamav-data/" --log=/dev/stdout

# Replace the current virus database with the new one:
rm -rf "${build}/.clamav-data"
cp -rp "${cache}/clamav-data" "${build}/.clamav-data"
