#!/usr/bin/env bash
# bin/compile build_path cache_path
#
# See https://blog.heroku.com/hacking-buildpacks#compile for good documentation
#
# build - gives you a handle for the root directory of the app
# cache - gives you a location to persist build artifacts between deployments
#
build="$1" # something like /tmp/build_<uuid>
cache="$2" # /app/tmp/cache

set -e
mkdir -p "${cache}/clamav-data"

mkdir -p "${build}/.apt/var/run/clamav/"
touch "${build}/.apt/var/run/clamav/clamd.sock"

freshclam --config-file="${build}/config/antivirus/freshclam.conf" --datadir="${cache}/clamav-data/" --log=/dev/stdout

# Replace the current virus database with the new one:
rm -rf "${build}/.clamav-data"
cp -rp "${cache}/clamav-data" "${build}/.clamav-data"
